{% extends "base.html" %}

{% block title %}Relatórios - Biblioteca{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-chart-bar"></i>
            Relatórios e Estatísticas
        </h1>
        <p class="page-subtitle">Análise detalhada do sistema da biblioteca</p>
    </div>
    
    <!-- Filter Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.relatorios') }}" id="filterForm">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Período</label>
                            <select name="periodo" class="form-control form-select">
                                <option value="7" {% if periodo == '7' %}selected{% endif %}>Últimos 7 dias</option>
                                <option value="30" {% if periodo == '30' %}selected{% endif %}>Últimos 30 dias</option>
                                <option value="90" {% if periodo == '90' %}selected{% endif %}>Últimos 3 meses</option>
                                <option value="365" {% if periodo == '365' %}selected{% endif %}>Último ano</option>
                                <option value="all" {% if periodo == 'all' %}selected{% endif %}>Todo o período</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Data Inicial</label>
                            <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Data Final</label>
                            <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-1">
                                    <i class="fas fa-filter"></i> Filtrar
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportReport()">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.total_utilizadores }}</h3>
                    <p>Utilizadores Ativos</p>
                    <small class="text-success">
                        <i class="fas fa-arrow-up"></i>
                        +{{ stats.novos_utilizadores }} este mês
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon books">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.total_livros }}</h3>
                    <p>Livros no Catálogo</p>
                    <small class="text-info">
                        {{ stats.livros_disponiveis }} disponíveis
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon loans">
                    <i class="fas fa-handshake"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.total_emprestimos }}</h3>
                    <p>Empréstimos Realizados</p>
                    <small class="text-warning">
                        {{ stats.emprestimos_ativos }} ativos
                    </small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon efficiency">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.taxa_utilizacao }}%</h3>
                    <p>Taxa de Utilização</p>
                    <small class="text-muted">
                        Livros emprestados vs disponíveis
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Loans Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-area"></i>
                        Empréstimos ao Longo do Tempo
                    </h3>
                    <div class="card-actions">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline active" data-chart="loans">Empréstimos</button>
                            <button class="btn btn-outline" data-chart="returns">Devoluções</button>
                            <button class="btn btn-outline" data-chart="overdue">Em Atraso</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="loansChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <!-- Categories Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-pie"></i>
                        Categorias Mais Populares
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="categoriesChart" width="300" height="300"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="categories-list">
                                {% for categoria in categorias_populares %}
                                <div class="category-item">
                                    <div class="category-info">
                                        <span class="category-name">{{ categoria.nome }}</span>
                                        <span class="category-count">{{ categoria.total }} empréstimos</span>
                                    </div>
                                    <div class="category-bar">
                                        <div class="category-progress" style="width: {{ categoria.percentagem }}%"></div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Activity -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-user-clock"></i>
                        Atividade dos Utilizadores
                    </h3>
                </div>
                <div class="card-body">
                    <div class="activity-heatmap">
                        <div class="heatmap-header">
                            <div class="time-labels">
                                <span>00</span><span>06</span><span>12</span><span>18</span><span>24</span>
                            </div>
                        </div>
                        <div class="heatmap-body">
                            {% for dia in atividade_semanal %}
                            <div class="heatmap-row">
                                <div class="day-label">{{ dia.nome }}</div>
                                <div class="hour-cells">
                                    {% for hora in dia.horas %}
                                    <div class="hour-cell" 
                                         data-value="{{ hora.valor }}" 
                                         style="background-color: rgba(62, 142, 222, {{ hora.intensidade }});"
                                         title="{{ dia.nome }} {{ hora.hora }}:00 - {{ hora.valor }} atividades">
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Top Users -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-trophy"></i>
                        Top Utilizadores
                    </h3>
                </div>
                <div class="card-body">
                    <div class="top-users-list">
                        {% for utilizador in top_utilizadores %}
                        <div class="user-item">
                            <div class="user-rank">{{ loop.index }}</div>
                            <div class="user-avatar">
                                <span>{{ utilizador.nome[0].upper() }}{{ utilizador.nome.split()[1][0].upper() if utilizador.nome.split()|length > 1 else '' }}</span>
                            </div>
                            <div class="user-info">
                                <div class="user-name">{{ utilizador.nome }}</div>
                                <div class="user-stats">{{ utilizador.total_emprestimos }} empréstimos</div>
                            </div>
                            <div class="user-badge">
                                <span class="badge badge-{{ utilizador.tipo }}">{{ utilizador.tipo.title() }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Top Books -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-star"></i>
                        Livros Mais Populares
                    </h3>
                </div>
                <div class="card-body">
                    <div class="top-books-list">
                        {% for livro in livros_populares %}
                        <div class="book-item">
                            <div class="book-rank">{{ loop.index }}</div>
                            <div class="book-cover">
                                {% if livro.capa %}
                                    <img src="{{ url_for('static', filename=livro.capa) }}" alt="{{ livro.titulo }}">
                                {% else %}
                                    <div class="cover-placeholder">
                                        <i class="fas fa-book"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="book-info">
                                <div class="book-title">{{ livro.titulo }}</div>
                                <div class="book-author">{{ livro.autor }}</div>
                                <div class="book-stats">{{ livro.total_emprestimos }} empréstimos</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-clock"></i>
                        Atividade Recente
                    </h3>
                </div>
                <div class="card-body">
                    <div class="recent-activity">
                        {% for atividade in atividades_recentes %}
                        <div class="activity-item">
                            <div class="activity-icon activity-{{ atividade.tipo }}">
                                <i class="fas fa-{{ atividade.icone }}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">{{ atividade.titulo }}</div>
                                <div class="activity-description">{{ atividade.descricao }}</div>
                                <div class="activity-time">{{ atividade.tempo_relativo }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stats-card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    transition: var(--transition);
    height: 100%;
}

.stats-card:hover {
    box-shadow: var(--shadow);
    transform: translateY(-2px);
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.5rem;
    color: var(--white);
}

.stats-icon.users { background: var(--primary-color); }
.stats-icon.books { background: var(--accent-3); }
.stats-icon.loans { background: var(--success-color); }
.stats-icon.efficiency { background: var(--accent-2); }

.stats-content h3 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: var(--accent-1);
}

.stats-content p {
    margin: 0.25rem 0 0 0;
    color: var(--accent-1);
    font-weight: 500;
}

.stats-content small {
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.btn-group .btn.active {
    background: var(--primary-color);
    color: var(--white);
    border-color: var(--primary-color);
}

.categories-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 300px;
    overflow-y: auto;
}

.category-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.category-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.category-name {
    font-weight: 600;
    color: var(--accent-1);
}

.category-count {
    font-size: 0.9rem;
    color: #6c757d;
}

.category-bar {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.category-progress {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-3));
    transition: width 0.3s ease;
}

.activity-heatmap {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 1rem;
}

.heatmap-header {
    margin-bottom: 1rem;
}

.time-labels {
    display: flex;
    justify-content: space-between;
    padding-left: 60px;
    font-size: 0.8rem;
    color: #6c757d;
}

.heatmap-row {
    display: flex;
    align-items: center;
    margin-bottom: 0.25rem;
}

.day-label {
    width: 50px;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--accent-1);
}

.hour-cells {
    display: flex;
    gap: 1px;
    flex: 1;
}

.hour-cell {
    flex: 1;
    height: 12px;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.hour-cell:hover {
    transform: scale(1.2);
    z-index: 10;
    position: relative;
}

.top-users-list,
.top-books-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.user-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: var(--light-gray);
    border-radius: var(--border-radius);
}

.user-rank {
    width: 30px;
    height: 30px;
    background: var(--primary-color);
    color: var(--white);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
}

.user-avatar {
    width: 40px;
    height: 40px;
    background: var(--accent-3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 600;
    font-size: 0.9rem;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: var(--accent-1);
    margin-bottom: 0.25rem;
}

.user-stats {
    font-size: 0.8rem;
    color: #6c757d;
}

.user-badge .badge {
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    font-size: 0.7rem;
}

.badge-admin { background: rgba(62, 142, 222, 0.1); color: var(--primary-color); }
.badge-professor { background: rgba(81, 196, 211, 0.1); color: var(--accent-3); }
.badge-aluno { background: rgba(40, 167, 69, 0.1); color: var(--success-color); }

.book-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: var(--light-gray);
    border-radius: var(--border-radius);
}

.book-rank {
    width: 30px;
    height: 30px;
    background: var(--accent-2);
    color: var(--white);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
}

.book-cover {
    width: 40px;
    height: 55px;
    border-radius: var(--border-radius);
    overflow: hidden;
    flex-shrink: 0;
}

.book-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.cover-placeholder {
    width: 100%;
    height: 100%;
    background: #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 1rem;
}

.book-info {
    flex: 1;
    min-width: 0;
}

.book-title {
    font-weight: 600;
    color: var(--accent-1);
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.book-author {
    font-size: 0.8rem;
    color: var(--primary-color);
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.book-stats {
    font-size: 0.7rem;
    color: #6c757d;
}

.recent-activity {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.activity-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 0.8rem;
    flex-shrink: 0;
}

.activity-emprestimo { background: var(--primary-color); }
.activity-devolucao { background: var(--success-color); }
.activity-usuario { background: var(--accent-3); }
.activity-livro { background: var(--accent-2); }

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-title {
    font-weight: 600;
    color: var(--accent-1);
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.activity-description {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
    line-height: 1.3;
}

.activity-time {
    font-size: 0.7rem;
    color: #6c757d;
}

@media (max-width: 768px) {
    .stats-card {
        margin-bottom: 1rem;
    }
    
    .card-actions {
        margin-top: 1rem;
    }
    
    .btn-group {
        width: 100%;
    }
    
    .btn-group .btn {
        flex: 1;
    }
    
    .user-item,
    .book-item {
        padding: 0.5rem;
    }
    
    .time-labels {
        font-size: 0.7rem;
    }
    
    .hour-cell {
        height: 10px;
    }
    
    .categories-list {
        margin-top: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initLoansChart();
    initCategoriesChart();
    
    // Chart type buttons
    const chartButtons = document.querySelectorAll('[data-chart]');
    chartButtons.forEach(button => {
        button.addEventListener('click', function() {
            chartButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            updateLoansChart(this.dataset.chart);
        });
    });
    
    // Auto-update period selector
    const periodoSelect = document.querySelector('select[name="periodo"]');
    periodoSelect.addEventListener('change', function() {
        if (this.value !== 'custom') {
            document.getElementById('filterForm').submit();
        }
    });
    
    // Animate stats cards
    const statsCards = document.querySelectorAll('.stats-card');
    statsCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 * index);
    });
    
    // Animate numbers in stats cards
    const numbers = document.querySelectorAll('.stats-content h3');
    numbers.forEach((number, index) => {
        const finalValue = parseInt(number.textContent.replace(/[^\d]/g, ''));
        if (!isNaN(finalValue)) {
            number.textContent = '0';
            setTimeout(() => {
                animateNumber(number, 0, finalValue, 1000);
            }, 500 + (200 * index));
        }
    });
});

function initLoansChart() {
    const ctx = document.getElementById('loansChart').getContext('2d');
    window.loansChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_data.labels | tojsonfilter }},
            datasets: [{
                label: 'Empréstimos',
                data: {{ chart_data.emprestimos | tojsonfilter }},
                borderColor: 'rgb(62, 142, 222)',
                backgroundColor: 'rgba(62, 142, 222, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

function initCategoriesChart() {
    const ctx = document.getElementById('categoriesChart').getContext('2d');
    window.categoriesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ categorias_chart.labels | tojsonfilter }},
            datasets: [{
                data: {{ categorias_chart.data | tojsonfilter }},
                backgroundColor: [
                    'rgb(62, 142, 222)',
                    'rgb(81, 196, 211)',
                    'rgb(40, 167, 69)',
                    'rgb(255, 193, 7)',
                    'rgb(220, 53, 69)',
                    'rgb(108, 117, 125)',
                    'rgb(253, 126, 20)',
                    'rgb(111, 66, 193)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateLoansChart(type) {
    let data, label, color;
    
    switch(type) {
        case 'returns':
            data = {{ chart_data.devolucoes | tojsonfilter }};
            label = 'Devoluções';
            color = 'rgb(40, 167, 69)';
            break;
        case 'overdue':
            data = {{ chart_data.atrasos | tojsonfilter }};
            label = 'Em Atraso';
            color = 'rgb(220, 53, 69)';
            break;
        default:
            data = {{ chart_data.emprestimos | tojsonfilter }};
            label = 'Empréstimos';
            color = 'rgb(62, 142, 222)';
    }
    
    window.loansChart.data.datasets[0] = {
        label: label,
        data: data,
        borderColor: color,
        backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
        fill: true,
        tension: 0.4
    };
    
    window.loansChart.update();
}

function animateNumber(element, start, end, duration) {
    const startTime = Date.now();
    const timer = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = Math.floor(start + (end - start) * progress);
        
        element.textContent = current.toLocaleString();
        
        if (progress >= 1) {
            clearInterval(timer);
        }
    }, 16);
}

function exportReport() {
    const params = new URLSearchParams(window.location.search);
    window.open("{{ url_for('admin.export_relatorio') }}?" + params.toString(), '_blank');
}
</script>
{% endblock %} 