{% extends "base.html" %}

{% block title %}Gerir Utilizadores - Biblioteca{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Gerir Utilizadores</h1>
        <p class="page-subtitle">Administre os utilizadores do sistema</p>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon admin">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.admins }}</h3>
                    <p>Administradores</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon professor">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.professores }}</h3>
                    <p>Professores</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon student">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.alunos }}</h3>
                    <p>Alunos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon total">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.total }}</h3>
                    <p>Total</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <form method="GET" action="{{ url_for('admin.gerir_utilizadores') }}" class="search-form">
                        <div class="row">
                            <div class="col-md-5">
                                <div class="form-group">
                                    <div class="input-group">
                                        <input type="text" 
                                               name="search" 
                                               class="form-control" 
                                               placeholder="Pesquisar por nome ou email..."
                                               value="{{ search }}">
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <select name="tipo" class="form-control form-select">
                                        <option value="">Todos os tipos</option>
                                        <option value="admin" {% if tipo_filtro == 'admin' %}selected{% endif %}>Administradores</option>
                                        <option value="professor" {% if tipo_filtro == 'professor' %}selected{% endif %}>Professores</option>
                                        <option value="aluno" {% if tipo_filtro == 'aluno' %}selected{% endif %}>Alunos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <select name="status" class="form-control form-select">
                                        <option value="">Todos os status</option>
                                        <option value="ativo" {% if status_filtro == 'ativo' %}selected{% endif %}>Ativos</option>
                                        <option value="inativo" {% if status_filtro == 'inativo' %}selected{% endif %}>Inativos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-outline w-100">
                                    <i class="fas fa-filter"></i> Filtrar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="col-lg-4 text-right">
                    <a href="{{ url_for('admin.add_utilizador') }}" class="btn btn-success">
                        <i class="fas fa-user-plus"></i> Novo Utilizador
                    </a>
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#importModal">
                        <i class="fas fa-file-import"></i> Importar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                Lista de Utilizadores
                {% if search or tipo_filtro or status_filtro %}
                    <small class="text-muted">({{ utilizadores|length }} resultados)</small>
                {% endif %}
            </h3>
            <div class="card-actions">
                {% if utilizadores %}
                <button class="btn btn-outline btn-sm" onclick="exportUsers()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                {% endif %}
            </div>
        </div>
        <div class="card-body p-0">
            {% if utilizadores %}
            <div class="table-responsive">
                <table class="table users-table">
                    <thead>
                        <tr>
                            <th>
                                <div class="custom-checkbox">
                                    <input type="checkbox" id="selectAll">
                                    <label for="selectAll"></label>
                                </div>
                            </th>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Empréstimos</th>
                            <th>Último Acesso</th>
                            <th width="120">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for utilizador in utilizadores %}
                        <tr data-user-id="{{ utilizador[0] }}">
                            <td>
                                <div class="custom-checkbox">
                                    <input type="checkbox" class="user-checkbox" value="{{ utilizador[0] }}">
                                    <label></label>
                                </div>
                            </td>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <span>{{ utilizador[1][0].upper() }}{{ utilizador[1].split()[1][0].upper() if utilizador[1].split()|length > 1 else '' }}</span>
                                    </div>
                                    <div class="user-details">
                                        <strong>{{ utilizador[1] }}</strong>
                                        <small class="text-muted d-block">ID: #{{ utilizador[0] }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="user-email">{{ utilizador[2] }}</span>
                            </td>
                            <td>
                                <span class="user-type-badge user-type-{{ utilizador[4] }}">
                                    <i class="fas fa-{% if utilizador[4] == 'admin' %}user-shield{% elif utilizador[4] == 'professor' %}chalkboard-teacher{% else %}user-graduate{% endif %}"></i>
                                    {{ utilizador[4].title() }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge status-{% if utilizador[5] == 'ativo' %}active{% else %}inactive{% endif %}">
                                    <i class="fas fa-circle"></i>
                                    {{ utilizador[5].title() }}
                                </span>
                            </td>
                            <td>
                                <div class="loan-stats">
                                    <span class="loan-count">{{ utilizador[6] if utilizador[6] else 0 }}</span>
                                    <small class="text-muted">empréstimos</small>
                                </div>
                            </td>
                            <td>
                                <span class="last-access">
                                    {% if utilizador[7] %}
                                        {{ utilizador[7].strftime('%d/%m/%Y') }}
                                        <small class="text-muted d-block">{{ utilizador[7].strftime('%H:%M') }}</small>
                                    {% else %}
                                        <span class="text-muted">Nunca</span>
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline" 
                                                data-bs-toggle="dropdown" 
                                                aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('admin.detalhes_utilizador', id=utilizador[0]) }}">
                                                    <i class="fas fa-eye"></i> Ver Detalhes
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('admin.editar_utilizador', id=utilizador[0]) }}">
                                                    <i class="fas fa-edit"></i> Editar
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" 
                                                   href="{{ url_for('admin.reset_password', id=utilizador[0]) }}">
                                                    <i class="fas fa-key"></i> Reset Password
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            {% if utilizador[5] == 'ativo' %}
                                            <li>
                                                <form method="POST" 
                                                      action="{{ url_for('admin.toggle_user_status', id=utilizador[0]) }}" 
                                                      style="margin: 0;">
                                                    <button type="submit" class="dropdown-item text-warning">
                                                        <i class="fas fa-ban"></i> Desativar
                                                    </button>
                                                </form>
                                            </li>
                                            {% else %}
                                            <li>
                                                <form method="POST" 
                                                      action="{{ url_for('admin.toggle_user_status', id=utilizador[0]) }}" 
                                                      style="margin: 0;">
                                                    <button type="submit" class="dropdown-item text-success">
                                                        <i class="fas fa-check"></i> Ativar
                                                    </button>
                                                </form>
                                            </li>
                                            {% endif %}
                                            {% if utilizador[0] != session.user_id and utilizador[4] != 'admin' %}
                                            <li>
                                                <form method="POST" 
                                                      action="{{ url_for('admin.delete_utilizador', id=utilizador[0]) }}" 
                                                      style="margin: 0;"
                                                      onsubmit="return confirm('Tem certeza de que deseja eliminar este utilizador? Esta ação não pode ser desfeita.')">
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="fas fa-trash"></i> Eliminar
                                                    </button>
                                                </form>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <div class="empty-state">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h3>Nenhum utilizador encontrado</h3>
                    <p class="text-muted">
                        {% if search or tipo_filtro or status_filtro %}
                            Não foram encontrados utilizadores com os critérios especificados.
                            <br><a href="{{ url_for('admin.gerir_utilizadores') }}">Ver todos os utilizadores</a>
                        {% else %}
                            Não há utilizadores registados no sistema.
                            <br><a href="{{ url_for('admin.add_utilizador') }}">Adicionar primeiro utilizador</a>
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Bulk Actions (when users are selected) -->
    <div id="bulkActions" class="bulk-actions" style="display: none;">
        <div class="bulk-actions-content">
            <span class="selected-count">0 utilizadores selecionados</span>
            <div class="bulk-buttons">
                <button class="btn btn-warning btn-sm" onclick="bulkAction('deactivate')">
                    <i class="fas fa-ban"></i> Desativar
                </button>
                <button class="btn btn-success btn-sm" onclick="bulkAction('activate')">
                    <i class="fas fa-check"></i> Ativar
                </button>
                <button class="btn btn-info btn-sm" onclick="bulkAction('export')">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button class="btn btn-danger btn-sm" onclick="bulkAction('delete')">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Importar Utilizadores</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.importar_utilizadores') }}" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Arquivo CSV</label>
                        <input type="file" name="csv_file" class="form-control" accept=".csv" required>
                        <small class="form-text text-muted">
                            O arquivo deve ter as colunas: nome, email, tipo_utilizador
                        </small>
                    </div>
                    <div class="alert alert-info">
                        <strong>Formato esperado:</strong><br>
                        nome,email,tipo_utilizador<br>
                        João Silva,joao@example.com,aluno<br>
                        Maria Santos,maria@example.com,professor
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> Importar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.stats-card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    transition: var(--transition);
}

.stats-card:hover {
    box-shadow: var(--shadow);
    transform: translateY(-2px);
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.5rem;
    color: var(--white);
}

.stats-icon.admin { background: var(--primary-color); }
.stats-icon.professor { background: var(--accent-3); }
.stats-icon.student { background: var(--success-color); }
.stats-icon.total { background: var(--accent-2); }

.stats-content h3 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: var(--accent-1);
}

.stats-content p {
    margin: 0;
    color: #6c757d;
    font-weight: 500;
}

.search-form .form-group {
    margin-bottom: 0;
}

.input-group-append {
    margin-left: -1px;
}

.input-group-append .btn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.users-table {
    margin-bottom: 0;
}

.users-table th {
    border-top: none;
    font-weight: 600;
    color: var(--accent-1);
    background: var(--light-gray);
    vertical-align: middle;
}

.users-table td {
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}

.user-info {
    display: flex;
    align-items: center;
}

.user-avatar {
    width: 40px;
    height: 40px;
    background: var(--primary-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 600;
    margin-right: 0.75rem;
    font-size: 0.9rem;
}

.user-details strong {
    color: var(--accent-1);
}

.user-email {
    color: var(--primary-color);
    font-family: monospace;
}

.user-type-badge {
    padding: 0.35rem 0.75rem;
    border-radius: var(--border-radius);
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.user-type-admin {
    background: rgba(62, 142, 222, 0.1);
    color: var(--primary-color);
}

.user-type-professor {
    background: rgba(81, 196, 211, 0.1);
    color: var(--accent-3);
}

.user-type-aluno {
    background: rgba(40, 167, 69, 0.1);
    color: var(--success-color);
}

.status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: var(--border-radius);
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.status-active {
    background: rgba(40, 167, 69, 0.1);
    color: var(--success-color);
}

.status-inactive {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

.status-badge i {
    font-size: 0.6rem;
}

.loan-stats {
    text-align: center;
}

.loan-count {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--accent-1);
    display: block;
}

.last-access {
    font-size: 0.9rem;
}

.custom-checkbox {
    display: flex;
    align-items: center;
}

.custom-checkbox input {
    margin: 0;
    transform: scale(1.1);
}

.custom-checkbox label {
    margin: 0;
    cursor: pointer;
}

.bulk-actions {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
}

.bulk-actions-content {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow);
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border: 1px solid #dee2e6;
}

.selected-count {
    font-weight: 600;
    color: var(--accent-1);
}

.bulk-buttons {
    display: flex;
    gap: 0.5rem;
}

.empty-state {
    max-width: 400px;
    margin: 0 auto;
}

@media (max-width: 768px) {
    .stats-card {
        margin-bottom: 1rem;
    }
    
    .card-actions {
        margin-top: 1rem;
    }
    
    .search-form .row > div {
        margin-bottom: 1rem;
    }
    
    .users-table {
        font-size: 0.9rem;
    }
    
    .user-info {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .user-avatar {
        margin-bottom: 0.5rem;
    }
    
    .bulk-actions-content {
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.querySelector('.selected-count');
    
    // Handle select all
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActions();
        });
    }
    
    // Handle individual checkboxes
    userCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActions();
            
            // Update select all checkbox
            const checkedCount = document.querySelectorAll('.user-checkbox:checked').length;
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = checkedCount === userCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < userCheckboxes.length;
            }
        });
    });
    
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
        if (checkedBoxes.length > 0) {
            bulkActions.style.display = 'block';
            selectedCount.textContent = `${checkedBoxes.length} utilizador${checkedBoxes.length !== 1 ? 'es' : ''} selecionado${checkedBoxes.length !== 1 ? 's' : ''}`;
        } else {
            bulkActions.style.display = 'none';
        }
    }
    
    // Animate table rows
    const tableRows = document.querySelectorAll('.users-table tbody tr');
    tableRows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            row.style.transition = 'all 0.4s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, 50 * index);
    });
});

// Bulk actions
function bulkAction(action) {
    const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
    const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('Selecione pelo menos um utilizador.');
        return;
    }
    
    let confirmMessage = '';
    let url = '';
    
    switch (action) {
        case 'activate':
            confirmMessage = `Deseja ativar ${selectedIds.length} utilizador${selectedIds.length !== 1 ? 'es' : ''}?`;
            url = "{{ url_for('admin.bulk_activate_users') }}";
            break;
        case 'deactivate':
            confirmMessage = `Deseja desativar ${selectedIds.length} utilizador${selectedIds.length !== 1 ? 'es' : ''}?`;
            url = "{{ url_for('admin.bulk_deactivate_users') }}";
            break;
        case 'delete':
            confirmMessage = `Tem certeza de que deseja eliminar ${selectedIds.length} utilizador${selectedIds.length !== 1 ? 'es' : ''}? Esta ação não pode ser desfeita.`;
            url = "{{ url_for('admin.bulk_delete_users') }}";
            break;
        case 'export':
            exportSelectedUsers(selectedIds);
            return;
    }
    
    if (confirm(confirmMessage)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = url;
        
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'user_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Export functions
function exportUsers() {
    window.location.href = "{{ url_for('admin.export_users') }}";
}

function exportSelectedUsers(selectedIds) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('admin.export_selected_users') }}";
    
    selectedIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'user_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %} 