{% extends "base.html" %}

{% block title %}Adicionar Utilizador - Biblioteca{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('admin.gerir_utilizadores') }}">Utilizadores</a></li>
                <li class="breadcrumb-item active">Adicionar</li>
            </ol>
        </nav>
        <h1 class="page-title">Adicionar Novo Utilizador</h1>
        <p class="page-subtitle">Crie uma nova conta de utilizador no sistema</p>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.add_utilizador') }}" id="addUserForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label required">Nome Completo</label>
                                    <input type="text" 
                                           name="nome" 
                                           class="form-control" 
                                           placeholder="Digite o nome completo"
                                           required>
                                    <div class="invalid-feedback">
                                        Por favor, insira o nome completo.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label required">Email</label>
                                    <input type="email" 
                                           name="email" 
                                           class="form-control" 
                                           placeholder="Digite o endereço de email"
                                           required>
                                    <div class="invalid-feedback">
                                        Por favor, insira um email válido.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label required">Tipo de Utilizador</label>
                                    <select name="tipo_utilizador" class="form-control form-select" required>
                                        <option value="">Selecione o tipo</option>
                                        <option value="admin">Administrador</option>
                                        <option value="professor">Professor</option>
                                        <option value="aluno">Aluno</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, selecione o tipo de utilizador.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label required">Password</label>
                                    <div class="password-input">
                                        <input type="password" 
                                               name="password" 
                                               class="form-control" 
                                               placeholder="Digite a password"
                                               id="password"
                                               required
                                               minlength="6">
                                        <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">
                                        A password deve ter pelo menos 6 caracteres.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label required">Confirmar Password</label>
                                    <div class="password-input">
                                        <input type="password" 
                                               name="confirmar_password" 
                                               class="form-control" 
                                               placeholder="Confirme a password"
                                               id="confirmarPassword"
                                               required
                                               minlength="6">
                                        <button type="button" class="password-toggle" onclick="togglePassword('confirmarPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">
                                        As passwords não coincidem.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select name="status" class="form-control form-select">
                                        <option value="ativo" selected>Ativo</option>
                                        <option value="inativo">Inativo</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Utilizadores inativos não podem fazer login
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Type Descriptions -->
                        <div class="user-types-info">
                            <h5>Tipos de Utilizador:</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="type-card type-admin">
                                        <div class="type-icon">
                                            <i class="fas fa-user-shield"></i>
                                        </div>
                                        <div class="type-content">
                                            <h6>Administrador</h6>
                                            <p>Acesso completo ao sistema, pode gerir utilizadores, livros e empréstimos</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="type-card type-professor">
                                        <div class="type-icon">
                                            <i class="fas fa-chalkboard-teacher"></i>
                                        </div>
                                        <div class="type-content">
                                            <h6>Professor</h6>
                                            <p>Pode fazer empréstimos de livros com período estendido</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="type-card type-aluno">
                                        <div class="type-icon">
                                            <i class="fas fa-user-graduate"></i>
                                        </div>
                                        <div class="type-content">
                                            <h6>Aluno</h6>
                                            <p>Pode fazer empréstimos de livros com período padrão</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Options -->
                        <div class="additional-options">
                            <h5>Opções Adicionais:</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="custom-checkbox">
                                        <input type="checkbox" id="enviarEmail" name="enviar_email" checked>
                                        <label for="enviarEmail">
                                            <i class="fas fa-envelope"></i>
                                            Enviar email de boas-vindas
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">
                                        Enviar credenciais de acesso por email
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <div class="custom-checkbox">
                                        <input type="checkbox" id="alterarPassword" name="alterar_password_primeiro_login">
                                        <label for="alterarPassword">
                                            <i class="fas fa-key"></i>
                                            Forçar alteração de password
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">
                                        Utilizador deve alterar password no primeiro login
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-user-plus"></i> Criar Utilizador
                            </button>
                            <a href="{{ url_for('admin.gerir_utilizadores') }}" class="btn btn-outline">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="button" class="btn btn-info" onclick="generatePassword()">
                                <i class="fas fa-magic"></i> Gerar Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.breadcrumb {
    background: transparent;
    padding: 0;
    margin-bottom: 1rem;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: ">";
    color: #6c757d;
}

.breadcrumb-item a {
    color: var(--primary-color);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    color: var(--accent-3);
}

.required::after {
    content: " *";
    color: #dc3545;
}

.password-input {
    position: relative;
}

.password-toggle {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.password-toggle:hover {
    color: var(--primary-color);
}

.user-types-info {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--light-gray);
    border-radius: var(--border-radius);
}

.user-types-info h5 {
    margin-bottom: 1rem;
    color: var(--accent-1);
    font-weight: 600;
}

.type-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 1rem;
    height: 100%;
    transition: var(--transition);
    border: 2px solid transparent;
}

.type-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.type-card.type-admin:hover { border-color: var(--primary-color); }
.type-card.type-professor:hover { border-color: var(--accent-3); }
.type-card.type-aluno:hover { border-color: var(--success-color); }

.type-icon {
    width: 50px;
    height: 50px;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.25rem;
    color: var(--white);
}

.type-admin .type-icon { background: var(--primary-color); }
.type-professor .type-icon { background: var(--accent-3); }
.type-aluno .type-icon { background: var(--success-color); }

.type-content h6 {
    text-align: center;
    margin-bottom: 0.5rem;
    color: var(--accent-1);
    font-weight: 600;
}

.type-content p {
    text-align: center;
    color: #6c757d;
    font-size: 0.9rem;
    margin: 0;
    line-height: 1.4;
}

.additional-options {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--light-gray);
    border-radius: var(--border-radius);
}

.additional-options h5 {
    margin-bottom: 1rem;
    color: var(--accent-1);
    font-weight: 600;
}

.custom-checkbox {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.custom-checkbox input {
    margin-right: 0.75rem;
    transform: scale(1.2);
}

.custom-checkbox label {
    margin: 0;
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: 500;
    color: var(--accent-1);
}

.custom-checkbox label i {
    margin-right: 0.5rem;
    color: var(--primary-color);
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #dee2e6;
}

.was-validated .form-control:invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.was-validated .form-control:valid {
    border-color: #28a745;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.6-.6c.18-.18.38-.29.6-.29.22 0 .42.11.6.29l1.05 1.05-1.05 1.05c-.18.18-.38.29-.6.29s-.42-.11-.6-.29l-.6-.6c-.12-.12-.12-.32 0-.44z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

@media (max-width: 768px) {
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .type-card {
        margin-bottom: 1rem;
    }
    
    .user-types-info,
    .additional-options {
        padding: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addUserForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmarPassword');
    const tipoSelect = document.querySelector('select[name="tipo_utilizador"]');
    const typeCards = document.querySelectorAll('.type-card');
    
    // Form validation
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Check password match
        if (passwordInput.value !== confirmPasswordInput.value) {
            e.preventDefault();
            confirmPasswordInput.setCustomValidity('As passwords não coincidem');
        } else {
            confirmPasswordInput.setCustomValidity('');
        }
        
        form.classList.add('was-validated');
    });
    
    // Password confirmation validation
    confirmPasswordInput.addEventListener('input', function() {
        if (this.value !== passwordInput.value) {
            this.setCustomValidity('As passwords não coincidem');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Highlight selected user type
    tipoSelect.addEventListener('change', function() {
        typeCards.forEach(card => {
            card.classList.remove('selected');
        });
        
        if (this.value) {
            const selectedCard = document.querySelector(`.type-${this.value}`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
        }
    });
    
    // Email validation
    const emailInput = document.querySelector('input[name="email"]');
    emailInput.addEventListener('blur', function() {
        // Simple email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (this.value && !emailRegex.test(this.value)) {
            this.setCustomValidity('Por favor, insira um email válido');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Real-time validation feedback
    const requiredInputs = form.querySelectorAll('input[required], select[required]');
    requiredInputs.forEach(input => {
        input.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            } else {
                this.classList.remove('is-valid');
            }
        });
    });
});

// Toggle password visibility
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Generate random password
function generatePassword() {
    const length = 12;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
    let password = "";
    
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmarPassword');
    
    passwordInput.value = password;
    confirmPasswordInput.value = password;
    
    // Show password temporarily
    passwordInput.type = 'text';
    confirmPasswordInput.type = 'text';
    
    // Update toggle buttons
    const toggleButtons = document.querySelectorAll('.password-toggle i');
    toggleButtons.forEach(icon => {
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    });
    
    // Hide password after 3 seconds
    setTimeout(() => {
        passwordInput.type = 'password';
        confirmPasswordInput.type = 'password';
        toggleButtons.forEach(icon => {
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        });
    }, 3000);
    
    // Trigger validation
    passwordInput.dispatchEvent(new Event('input'));
    confirmPasswordInput.dispatchEvent(new Event('input'));
    
    alert('Password gerada com sucesso! Será ocultada em 3 segundos.');
}
</script>

<style>
.type-card.selected {
    border-color: var(--primary-color) !important;
    box-shadow: var(--shadow-sm);
    transform: translateY(-2px);
}

.type-card.selected.type-admin {
    border-color: var(--primary-color) !important;
}

.type-card.selected.type-professor {
    border-color: var(--accent-3) !important;
}

.type-card.selected.type-aluno {
    border-color: var(--success-color) !important;
}
</style>
{% endblock %} 