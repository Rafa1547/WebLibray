{% extends "base.html" %}

{% block title %}Gerir Utilizadores{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="header-content">
            <h1><i class="fas fa-users-cog"></i> Gerir Utilizadores</h1>
            <p>Administração de utilizadores do sistema</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('admin.add_utilizador') }}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Adicionar Utilizador
            </a>
        </div>
    </div>
</div>

<div class="container">
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon admin">
                <i class="fas fa-crown"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.admin }}</h3>
                <p>Administradores</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon professor">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.professor }}</h3>
                <p>Professores</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon aluno">
                <i class="fas fa-user-graduate"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.aluno }}</h3>
                <p>Alunos</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon total">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total }}</h3>
                <p>Total</p>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-section">
        <div class="search-bar">
            <div class="search-input-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Pesquisar por nome ou email...">
            </div>
        </div>
        
        <div class="filter-controls">
            <select id="typeFilter">
                <option value="">Todos os tipos</option>
                <option value="admin">Administradores</option>
                <option value="professor">Professores</option>
                <option value="aluno">Alunos</option>
            </select>
            
            <select id="sortBy">
                <option value="nome">Ordenar por Nome</option>
                <option value="email">Ordenar por Email</option>
                <option value="tipo">Ordenar por Tipo</option>
                <option value="data_criacao">Ordenar por Data</option>
            </select>
            
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i> Limpar
            </button>
        </div>
    </div>

    <!-- Users Table -->
    <div class="table-container">
        <div class="table-header">
            <h3><i class="fas fa-list"></i> Lista de Utilizadores</h3>
            <div class="table-actions">
                <button class="btn btn-secondary btn-sm" onclick="exportUsers()">
                    <i class="fas fa-download"></i> Exportar
                </button>
            </div>
        </div>
        
        <div class="responsive-table">
            <table class="modern-table" id="usersTable">
                <thead>
                    <tr>
                        <th>
                            <div class="th-content">
                                <i class="fas fa-user"></i>
                                Utilizador
                            </div>
                        </th>
                        <th>
                            <div class="th-content">
                                <i class="fas fa-user-tag"></i>
                                Tipo
                            </div>
                        </th>
                        <th>
                            <div class="th-content">
                                <i class="fas fa-calendar"></i>
                                Data de Criação
                            </div>
                        </th>
                        <th>
                            <div class="th-content">
                                <i class="fas fa-book"></i>
                                Empréstimos
                            </div>
                        </th>
                        <th>
                            <div class="th-content">
                                <i class="fas fa-cogs"></i>
                                Ações
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for utilizador in utilizadores %}
                    <tr class="user-row" data-type="{{ utilizador[4] }}" data-name="{{ utilizador[1]|lower }}" data-email="{{ utilizador[2]|lower }}">
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="user-details">
                                    <strong>{{ utilizador[1] }}</strong>
                                    <span class="user-email">{{ utilizador[2] }}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="user-type-badge {{ utilizador[4] }}">
                                {% if utilizador[4] == 'admin' %}
                                    <i class="fas fa-crown"></i> Administrador
                                {% elif utilizador[4] == 'professor' %}
                                    <i class="fas fa-chalkboard-teacher"></i> Professor
                                {% else %}
                                    <i class="fas fa-user-graduate"></i> Aluno
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="date-info">
                                <strong>{{ utilizador[5][:10] }}</strong>
                                <span class="time-info">{{ utilizador[5][11:16] }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="loan-stats">
                                <span class="active-loans">{{ active_loans.get(utilizador[0], 0) }} ativos</span>
                                <span class="total-loans">{{ total_loans.get(utilizador[0], 0) }} total</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{{ url_for('admin.edit_utilizador', id=utilizador[0]) }}" 
                                   class="btn btn-sm btn-primary" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                
                                {% if utilizador[0] != session.user_id %}
                                <button class="btn btn-sm btn-danger delete-user-btn" 
                                        title="Eliminar"
                                        data-user-id="{{ utilizador[0] }}"
                                        data-user-name="{{ utilizador[1] }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                                
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-secondary dropdown-toggle" data-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu">
                                        <a href="{{ url_for('emprestimos.historico_utilizador', id=utilizador[0]) }}" class="dropdown-item">
                                            <i class="fas fa-history"></i> Ver Histórico
                                        </a>
                                        <a href="#" class="dropdown-item reset-password-btn" data-user-id="{{ utilizador[0] }}">
                                            <i class="fas fa-key"></i> Reset Password
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="no-data">
                            <div class="no-data-content">
                                <i class="fas fa-users"></i>
                                <h4>Nenhum utilizador encontrado</h4>
                                <p>Não existem utilizadores registados no sistema.</p>
                                <a href="{{ url_for('admin.add_utilizador') }}" class="btn btn-primary">
                                    <i class="fas fa-user-plus"></i> Adicionar Primeiro Utilizador
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminação</h4>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Tem a certeza que deseja eliminar o utilizador <strong id="deleteUserName"></strong>?</p>
            <div class="warning-box">
                <i class="fas fa-warning"></i>
                <p>Esta ação não pode ser desfeita. O utilizador não poderá ter empréstimos ativos.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <form id="deleteForm" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </form>
        </div>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.stat-icon.admin { background: linear-gradient(135deg, #8b5cf6, #a855f7); }
.stat-icon.professor { background: linear-gradient(135deg, #06b6d4, #0891b2); }
.stat-icon.aluno { background: linear-gradient(135deg, #10b981, #059669); }
.stat-icon.total { background: linear-gradient(135deg, #f59e0b, #d97706); }

.stat-content h3 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark-gray);
    margin: 0;
}

.stat-content p {
    color: #6b7280;
    margin: 0;
    font-weight: 500;
}

.filters-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.search-bar {
    margin-bottom: 1rem;
}

.search-input-container {
    position: relative;
    max-width: 400px;
}

.search-input-container i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
}

.search-input-container input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 2.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
}

.search-input-container input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.filter-controls {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.filter-controls select {
    padding: 0.5rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    font-size: 0.875rem;
}

.table-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.table-header {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: #f8fafc;
}

.table-header h3 {
    margin: 0;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.responsive-table {
    overflow-x: auto;
}

.modern-table {
    width: 100%;
    border-collapse: collapse;
}

.modern-table th {
    background: #f8fafc;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--dark-gray);
    border-bottom: 2px solid #e5e7eb;
}

.th-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modern-table td {
    padding: 1rem;
    border-bottom: 1px solid #f1f5f9;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--turquoise));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
}

.user-details strong {
    display: block;
    color: var(--dark-gray);
    font-weight: 600;
}

.user-email {
    color: #6b7280;
    font-size: 0.875rem;
}

.user-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.user-type-badge.admin {
    background: rgba(139, 92, 246, 0.1);
    color: #8b5cf6;
}

.user-type-badge.professor {
    background: rgba(6, 182, 212, 0.1);
    color: #06b6d4;
}

.user-type-badge.aluno {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.date-info strong {
    display: block;
    color: var(--dark-gray);
}

.time-info {
    color: #6b7280;
    font-size: 0.875rem;
}

.loan-stats {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.active-loans {
    color: var(--primary-color);
    font-weight: 600;
    font-size: 0.875rem;
}

.total-loans {
    color: #6b7280;
    font-size: 0.75rem;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.dropdown {
    position: relative;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    min-width: 150px;
    z-index: 1000;
    display: none;
}

.dropdown-menu.show {
    display: block;
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    color: var(--dark-gray);
    text-decoration: none;
    font-size: 0.875rem;
}

.dropdown-item:hover {
    background: #f8fafc;
}

.no-data {
    text-align: center;
    padding: 3rem;
}

.no-data-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.no-data-content i {
    font-size: 3rem;
    color: #d1d5db;
}

.no-data-content h4 {
    color: var(--dark-gray);
    margin: 0;
}

.no-data-content p {
    color: #6b7280;
    margin: 0;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.modal-header h4 {
    margin: 0;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
}

.modal-body {
    padding: 1.5rem;
}

.warning-box {
    display: flex;
    gap: 0.75rem;
    padding: 1rem;
    background: #fef3cd;
    border: 1px solid #fbbf24;
    border-radius: 8px;
    margin-top: 1rem;
}

.warning-box i {
    color: #f59e0b;
    font-size: 1.25rem;
}

.warning-box p {
    margin: 0;
    color: #92400e;
    font-size: 0.875rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid #e5e7eb;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-controls {
        flex-direction: column;
    }
    
    .table-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 0.25rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    const sortBy = document.getElementById('sortBy');
    
    // Search functionality
    searchInput.addEventListener('input', filterUsers);
    typeFilter.addEventListener('change', filterUsers);
    sortBy.addEventListener('change', sortUsers);
    
    // Delete user buttons
    document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const userName = this.dataset.userName;
            confirmDelete(userId, userName);
        });
    });
    
    // Reset password buttons
    document.querySelectorAll('.reset-password-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const userId = this.dataset.userId;
            resetPassword(userId);
        });
    });
    
    // Dropdown functionality
    document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const menu = this.nextElementSibling;
            
            // Close other dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            
            menu.classList.toggle('show');
        });
    });
    
    document.addEventListener('click', function() {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    });
});

function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const rows = document.querySelectorAll('.user-row');
    
    rows.forEach(row => {
        const name = row.dataset.name;
        const email = row.dataset.email;
        const type = row.dataset.type;
        
        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
        const matchesType = !typeFilter || type === typeFilter;
        
        if (matchesSearch && matchesType) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function sortUsers() {
    const sortBy = document.getElementById('sortBy').value;
    const tbody = document.querySelector('#usersTable tbody');
    const rows = Array.from(tbody.querySelectorAll('.user-row'));
    
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch (sortBy) {
            case 'nome':
                aValue = a.dataset.name;
                bValue = b.dataset.name;
                break;
            case 'email':
                aValue = a.dataset.email;
                bValue = b.dataset.email;
                break;
            case 'tipo':
                aValue = a.dataset.type;
                bValue = b.dataset.type;
                break;
            case 'data_criacao':
                aValue = a.cells[2].textContent.trim();
                bValue = b.cells[2].textContent.trim();
                break;
        }
        
        return aValue.localeCompare(bValue);
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('sortBy').value = 'nome';
    filterUsers();
    sortUsers();
}

function confirmDelete(userId, userName) {
    document.getElementById('deleteUserName').textContent = userName;
    document.getElementById('deleteForm').action = `/admin/utilizadores/${userId}/delete`;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

function resetPassword(userId) {
    const newPassword = prompt('Digite a nova password (mínimo 6 caracteres):');
    if (newPassword && newPassword.length >= 6) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/utilizadores/${userId}/reset-password`;
        
        const passwordInput = document.createElement('input');
        passwordInput.type = 'hidden';
        passwordInput.name = 'new_password';
        passwordInput.value = newPassword;
        
        const confirmInput = document.createElement('input');
        confirmInput.type = 'hidden';
        confirmInput.name = 'confirm_password';
        confirmInput.value = newPassword;
        
        form.appendChild(passwordInput);
        form.appendChild(confirmInput);
        document.body.appendChild(form);
        form.submit();
    } else if (newPassword !== null) {
        alert('A password deve ter pelo menos 6 caracteres!');
    }
}

function exportUsers() {
    // Future implementation for exporting users data
    alert('Funcionalidade de exportação em desenvolvimento!');
}
</script>
{% endblock %}