{% extends "base.html" %}

{% block title %}Gerir Empréstimos - Biblioteca{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Gerir Empréstimos</h1>
        <p class="page-subtitle">Controle de empréstimos e devoluções</p>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon active">
                    <i class="fas fa-book-reader"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.ativos }}</h3>
                    <p>Empréstimos Ativos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon overdue">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.em_atraso }}</h3>
                    <p>Em Atraso</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon returned">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.devolvidos }}</h3>
                    <p>Devolvidos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon total">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ stats.total }}</h3>
                    <p>Total</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('emprestimos.ver_emprestimos') }}">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">Pesquisar</label>
                            <div class="input-group">
                                <input type="text" 
                                       name="search" 
                                       class="form-control" 
                                       placeholder="Nome do utilizador ou título do livro..."
                                       value="{{ search }}">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-control form-select">
                                <option value="">Todos</option>
                                <option value="ativo" {% if status_filtro == 'ativo' %}selected{% endif %}>Ativos</option>
                                <option value="em_atraso" {% if status_filtro == 'em_atraso' %}selected{% endif %}>Em Atraso</option>
                                <option value="devolvido" {% if status_filtro == 'devolvido' %}selected{% endif %}>Devolvidos</option>
                                <option value="renovado" {% if status_filtro == 'renovado' %}selected{% endif %}>Renovados</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Tipo Utilizador</label>
                            <select name="tipo_usuario" class="form-control form-select">
                                <option value="">Todos</option>
                                <option value="professor" {% if tipo_filtro == 'professor' %}selected{% endif %}>Professores</option>
                                <option value="aluno" {% if tipo_filtro == 'aluno' %}selected{% endif %}>Alunos</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Data Inicial</label>
                            <input type="date" 
                                   name="data_inicio" 
                                   class="form-control" 
                                   value="{{ data_inicio }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Data Final</label>
                            <input type="date" 
                                   name="data_fim" 
                                   class="form-control" 
                                   value="{{ data_fim }}">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        <a href="{{ url_for('emprestimos.ver_emprestimos') }}" class="btn btn-outline">
                            <i class="fas fa-times"></i> Limpar Filtros
                        </a>
                        {% if session.user_type == 'admin' %}
                        <button type="button" class="btn btn-info" onclick="exportLoans()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Loans Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                Lista de Empréstimos
                {% if search or status_filtro or tipo_filtro or data_inicio or data_fim %}
                    <small class="text-muted">({{ emprestimos|length }} resultados)</small>
                {% endif %}
            </h3>
        </div>
        <div class="card-body p-0">
            {% if emprestimos %}
            <div class="table-responsive">
                <table class="table loans-table">
                    <thead>
                        <tr>
                            <th>Utilizador</th>
                            <th>Livro</th>
                            <th>Data Empréstimo</th>
                            <th>Data Limite</th>
                            <th>Data Devolução</th>
                            <th>Status</th>
                            <th>Dias</th>
                            <th width="150">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emprestimo in emprestimos %}
                        <tr data-loan-id="{{ emprestimo[0] }}" class="{% if emprestimo[10] %}loan-overdue{% endif %}">
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <span>{{ emprestimo[7][0].upper() }}{{ emprestimo[7].split()[1][0].upper() if emprestimo[7].split()|length > 1 else '' }}</span>
                                    </div>
                                    <div class="user-details">
                                        <strong>{{ emprestimo[7] }}</strong>
                                        <small class="text-muted d-block">{{ emprestimo[8].title() }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="book-info">
                                    <strong>{{ emprestimo[1] }}</strong>
                                    <small class="text-muted d-block">{{ emprestimo[2] }}</small>
                                </div>
                            </td>
                            <td>
                                <span class="date-display">
                                    {{ emprestimo[3].strftime('%d/%m/%Y') }}
                                    <small class="text-muted d-block">{{ emprestimo[3].strftime('%H:%M') }}</small>
                                </span>
                            </td>
                            <td>
                                <span class="date-display {% if emprestimo[10] %}text-danger{% endif %}">
                                    {{ emprestimo[4].strftime('%d/%m/%Y') }}
                                    {% if emprestimo[10] %}
                                        <small class="text-danger d-block">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            {{ emprestimo[11] }} dias de atraso
                                        </small>
                                    {% else %}
                                        <small class="text-muted d-block">
                                            {{ emprestimo[12] }} dias restantes
                                        </small>
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if emprestimo[5] %}
                                    <span class="date-display">
                                        {{ emprestimo[5].strftime('%d/%m/%Y') }}
                                        <small class="text-muted d-block">{{ emprestimo[5].strftime('%H:%M') }}</small>
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="loan-status-badge status-{{ emprestimo[6] }}">
                                    <i class="fas fa-{% if emprestimo[6] == 'ativo' %}clock{% elif emprestimo[6] == 'em_atraso' %}exclamation-triangle{% elif emprestimo[6] == 'devolvido' %}check-circle{% elif emprestimo[6] == 'renovado' %}redo{% endif %}"></i>
                                    {{ emprestimo[6].replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td>
                                <div class="days-info">
                                    {% if emprestimo[6] == 'devolvido' %}
                                        <span class="days-count">{{ emprestimo[13] }}</span>
                                        <small class="text-muted d-block">dias emprestado</small>
                                    {% elif emprestimo[10] %}
                                        <span class="days-count text-danger">+{{ emprestimo[11] }}</span>
                                        <small class="text-danger d-block">dias em atraso</small>
                                    {% else %}
                                        <span class="days-count">{{ emprestimo[12] }}</span>
                                        <small class="text-muted d-block">dias restantes</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    {% if emprestimo[6] in ['ativo', 'em_atraso', 'renovado'] %}
                                        <form method="POST" action="{{ url_for('emprestimos.devolver_livro', id=emprestimo[0]) }}" style="display: inline;">
                                            <button type="submit" class="btn btn-success btn-sm" title="Marcar como devolvido">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        {% if emprestimo[9] < 2 %}
                                        <form method="POST" action="{{ url_for('emprestimos.renovar_emprestimo', id=emprestimo[0]) }}" style="display: inline;">
                                            <button type="submit" class="btn btn-warning btn-sm" title="Renovar empréstimo">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    {% endif %}
                                    <button class="btn btn-info btn-sm" onclick="showLoanDetails( {{ emprestimo[0] }} )" title="Ver detalhes">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    {% if session.user_type == 'admin' and emprestimo[6] == 'devolvido' %}
                                    <form method="POST" action="{{ url_for('emprestimos.delete_emprestimo', id=emprestimo[0]) }}" 
                                          style="display: inline;"
                                          onsubmit="return confirm('Tem certeza de que deseja eliminar este registo de empréstimo?')">
                                        <button type="submit" class="btn btn-danger btn-sm" title="Eliminar registo">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <div class="empty-state">
                    <i class="fas fa-book-reader fa-3x text-muted mb-3"></i>
                    <h3>Nenhum empréstimo encontrado</h3>
                    <p class="text-muted">
                        {% if search or status_filtro or tipo_filtro or data_inicio or data_fim %}
                            Não foram encontrados empréstimos com os critérios especificados.
                            <br><a href="{{ url_for('emprestimos.ver_emprestimos') }}">Ver todos os empréstimos</a>
                        {% else %}
                            Não há empréstimos registados no sistema.
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Loan Details Modal -->
<div class="modal fade" id="loanDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Empréstimo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="loanDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<style>
.stats-card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    transition: var(--transition);
}

.stats-card:hover {
    box-shadow: var(--shadow);
    transform: translateY(-2px);
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.5rem;
    color: var(--white);
}

.stats-icon.active { background: var(--primary-color); }
.stats-icon.overdue { background: #dc3545; }
.stats-icon.returned { background: var(--success-color); }
.stats-icon.total { background: var(--accent-2); }

.stats-content h3 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: var(--accent-1);
}

.stats-content p {
    margin: 0;
    color: #6c757d;
    font-weight: 500;
}

.input-group-append {
    margin-left: -1px;
}

.input-group-append .btn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.loans-table {
    margin-bottom: 0;
}

.loans-table th {
    border-top: none;
    font-weight: 600;
    color: var(--accent-1);
    background: var(--light-gray);
    vertical-align: middle;
}

.loans-table td {
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}

.loan-overdue {
    background: rgba(220, 53, 69, 0.05);
}

.user-info {
    display: flex;
    align-items: center;
}

.user-avatar {
    width: 35px;
    height: 35px;
    background: var(--primary-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 600;
    margin-right: 0.75rem;
    font-size: 0.8rem;
}

.user-details strong {
    color: var(--accent-1);
}

.book-info strong {
    color: var(--accent-1);
}

.date-display {
    font-size: 0.9rem;
}

.loan-status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: var(--border-radius);
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.status-ativo {
    background: rgba(62, 142, 222, 0.1);
    color: var(--primary-color);
}

.status-em_atraso {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

.status-devolvido {
    background: rgba(40, 167, 69, 0.1);
    color: var(--success-color);
}

.status-renovado {
    background: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.days-info {
    text-align: center;
}

.days-count {
    font-size: 1.1rem;
    font-weight: 600;
    display: block;
}

.action-buttons {
    display: flex;
    gap: 0.25rem;
    justify-content: center;
}

.empty-state {
    max-width: 400px;
    margin: 0 auto;
}

@media (max-width: 768px) {
    .stats-card {
        margin-bottom: 1rem;
    }
    
    .loans-table {
        font-size: 0.85rem;
    }
    
    .user-info {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .user-avatar {
        margin-bottom: 0.5rem;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 0.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animate table rows
    const tableRows = document.querySelectorAll('.loans-table tbody tr');
    tableRows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            row.style.transition = 'all 0.4s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, 50 * index);
    });
    
    // Auto-refresh every 30 seconds for real-time updates
    setInterval(() => {
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.toString()) {
            location.reload();
        }
    }, 30000);
});

// Show loan details
function showLoanDetails(loanId) {
    // This would typically load details via AJAX
    const modal = new bootstrap.Modal(document.getElementById('loanDetailsModal'));
    const content = document.getElementById('loanDetailsContent');
    
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Simulate loading details
    setTimeout(() => {
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Informações do Empréstimo</h6>
                    <p><strong>ID:</strong> #${loanId}</p>
                    <p><strong>Data:</strong> 15/01/2024</p>
                    <p><strong>Prazo:</strong> 30/01/2024</p>
                </div>
                <div class="col-md-6">
                    <h6>Utilizador</h6>
                    <p><strong>Nome:</strong> João Silva</p>
                    <p><strong>Tipo:</strong> Aluno</p>
                    <p><strong>Email:</strong> joao@example.com</p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <h6>Livro</h6>
                    <p><strong>Título:</strong> Dom Casmurro</p>
                    <p><strong>Autor:</strong> Machado de Assis</p>
                    <p><strong>Categoria:</strong> Literatura</p>
                </div>
            </div>
        `;
    }, 1000);
}

// Export loans
function exportLoans() {
    const params = new URLSearchParams(window.location.search);
    window.location.href = "{{ url_for('emprestimos.export_emprestimos') }}?" + params.toString();
}
</script>
{% endblock %} 