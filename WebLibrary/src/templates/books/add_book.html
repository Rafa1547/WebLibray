{% extends "layouts/base.html" %}

{% block title %}Adicionar Livro - WebLibrary{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Adicionar Novo Livro</h1>
                    <p class="text-muted">Adicionar um novo livro ao catálogo da biblioteca</p>
                </div>
                <div>
                    <a href="{{ url_for('books.catalog') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar ao Catálogo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-book me-2"></i>Informações do Livro
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('books.add_book') }}" enctype="multipart/form-data">
                        <!-- Título -->
                        <div class="mb-3">
                            <label for="titulo" class="form-label">
                                <i class="fas fa-heading me-1"></i>Título *
                            </label>
                            <input type="text" class="form-control" id="titulo" name="titulo" 
                                   placeholder="Título do livro" required>
                        </div>

                        <!-- Autor -->
                        <div class="mb-3">
                            <label for="autor" class="form-label">
                                <i class="fas fa-user-edit me-1"></i>Autor *
                            </label>
                            <input type="text" class="form-control" id="autor" name="autor" 
                                   placeholder="Nome do autor" required>
                        </div>

                        <!-- ISBN e Ano -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="isbn" class="form-label">
                                        <i class="fas fa-barcode me-1"></i>ISBN <small class="text-muted">(opcional)</small>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="isbn" name="isbn" 
                                               placeholder="978-0-123456-78-9 (opcional)">
                                        <button class="btn btn-outline-primary" type="button" id="scanBarcodeBtn" 
                                                title="Escanear código de barras">
                                            <i class="fas fa-camera"></i> Escanear
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Digite manualmente ou use a câmera para escanear o código de barras.
                                        <span id="isbn-status" class="d-block mt-1"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ano" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Ano de Publicação
                                    </label>
                                    <input type="number" class="form-control" id="ano" name="ano" 
                                           placeholder="2024" min="1000" max="2030">
                                </div>
                            </div>
                        </div>

                        <!-- Categoria e Editora -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="categoria" class="form-label">
                                        <i class="fas fa-tags me-1"></i>Categoria *
                                    </label>
                                    <select class="form-select" id="categoria" name="categoria" required>
                                        <option value="">Selecione uma categoria</option>
                                        <option value="Arte">Arte</option>
                                        <option value="Autoajuda">Autoajuda</option>
                                        <option value="Biografia">Biografia</option>
                                        <option value="Ciência">Ciência</option>
                                        <option value="Culinária">Culinária</option>
                                        <option value="Desporto">Desporto</option>
                                        <option value="Direito">Direito</option>
                                        <option value="Economia">Economia</option>
                                        <option value="Educação">Educação</option>
                                        <option value="Ficção">Ficção</option>
                                        <option value="Ficção Científica">Ficção Científica</option>
                                        <option value="Filosofia">Filosofia</option>
                                        <option value="Geografia">Geografia</option>
                                        <option value="História">História</option>
                                        <option value="Infantil">Infantil</option>
                                        <option value="Literatura Clássica">Literatura Clássica</option>
                                        <option value="Línguas">Línguas</option>
                                        <option value="Matemática">Matemática</option>
                                        <option value="Medicina e Saúde">Medicina e Saúde</option>
                                        <option value="Psicologia">Psicologia</option>
                                        <option value="Religião">Religião</option>
                                        <option value="Romance">Romance</option>
                                        <option value="Tecnologia">Tecnologia</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editora" class="form-label">
                                        <i class="fas fa-building me-1"></i>Editora
                                    </label>
                                    <input type="text" class="form-control" id="editora" name="editora" 
                                           placeholder="Nome da editora">
                                </div>
                            </div>
                        </div>

                        <!-- Páginas e Idioma -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="paginas" class="form-label">
                                        <i class="fas fa-file-alt me-1"></i>Número de Páginas
                                    </label>
                                    <input type="number" class="form-control" id="paginas" name="paginas" 
                                           placeholder="250" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="idioma" class="form-label">
                                        <i class="fas fa-language me-1"></i>Idioma
                                    </label>
                                    <select class="form-select" id="idioma" name="idioma">
                                        <option value="Português">Português</option>
                                        <option value="Inglês">Inglês</option>
                                        <option value="Espanhol">Espanhol</option>
                                        <option value="Francês">Francês</option>
                                        <option value="Alemão">Alemão</option>
                                        <option value="Italiano">Italiano</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Descrição -->
                        <div class="mb-3">
                            <label for="descricao" class="form-label">
                                <i class="fas fa-align-left me-1"></i>Descrição
                            </label>
                            <textarea class="form-control" id="descricao" name="descricao" rows="4" 
                                      placeholder="Breve descrição do livro..."></textarea>
                        </div>

                        <!-- Status e Localização -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="status" class="form-label">
                                        <i class="fas fa-info-circle me-1"></i>Status
                                    </label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="disponivel">Disponível</option>
                                        <option value="emprestado">Emprestado</option>
                                        <option value="manutencao">Em Manutenção</option>
                                        <option value="perdido">Perdido</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="localizacao" class="form-label">
                                        <i class="fas fa-map-marker-alt me-1"></i>Localização
                                    </label>
                                    <input type="text" class="form-control" id="localizacao" name="localizacao" 
                                           placeholder="Ex: Estante A, Prateleira 3">
                                </div>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('books.catalog') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Adicionar Livro
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Card -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-eye me-2"></i>Pré-visualização
                    </h5>
                </div>
                <div class="card-body">
                    <div class="book-preview">
                        <div class="book-cover mb-3">
                            <img id="preview-cover" src="/static/images/covers/placeholder.jpg" 
                                 alt="Capa do livro" class="img-fluid rounded">
                        </div>
                        <h6 id="preview-title" class="fw-bold">Título do Livro</h6>
                        <p id="preview-author" class="text-muted mb-2">Autor</p>
                        <div class="mb-2">
                            <span id="preview-category" class="badge bg-primary">Categoria</span>
                        </div>
                        <div class="book-details">
                            <small class="text-muted">
                                <div id="preview-year">Ano: -</div>
                                <div id="preview-pages">Páginas: -</div>
                                <div id="preview-language">Idioma: Português</div>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload de Capa -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-image me-2"></i>Capa do Livro
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="capa" class="form-label">Upload da Capa</label>
                        <input type="file" class="form-control" id="capa" name="capa" 
                               accept="image/*" onchange="previewImage(this)">
                        <div class="form-text">Formatos aceites: JPG, PNG, GIF (máx. 2MB)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Scanner de Código de Barras -->
<div class="modal fade" id="barcodeModal" tabindex="-1" aria-labelledby="barcodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="barcodeModalLabel">
                    <i class="fas fa-camera me-2"></i>Scanner de Código de Barras
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <p class="mb-2">Posicione o código de barras ISBN dentro da área de captura</p>
                    <div class="alert alert-info" style="display: none;" id="camera-loading">
                        <i class="fas fa-spinner fa-spin me-2"></i>Iniciando câmera...
                    </div>
                    <div class="alert alert-danger" style="display: none;" id="camera-error">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="error-message">Erro ao aceder à câmera</span>
                    </div>
                </div>
                
                <!-- Container da Câmera -->
                <div id="scanner-container" class="text-center">
                    <div id="interactive" class="viewport border rounded position-relative" 
                         style="width: 100%; height: 300px; background: #000;">
                        <canvas class="drawingBuffer" style="position: absolute; top: 0; left: 0;"></canvas>
                        <!-- Overlay para guia visual -->
                        <div class="scanner-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                                           border: 2px solid #28a745; width: 80%; height: 100px; 
                                                           background: rgba(40, 167, 69, 0.1);">
                            <div class="text-center" style="margin-top: 35px;">
                                <small class="text-light">Posicione o código de barras aqui</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resultado do Scan -->
                <div id="scan-result" style="display: none;" class="mt-3">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Código detectado!</h6>
                        <p class="mb-2">ISBN encontrado: <strong id="detected-isbn"></strong></p>
                        <div id="book-info-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin me-2"></i>Buscando informações do livro...
                        </div>
                        <div id="book-info" style="display: none;"></div>
                    </div>
                </div>

                <!-- Controles -->
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-secondary me-2" id="stopScanBtn" style="display: none;">
                        <i class="fas fa-stop me-1"></i>Parar Scanner
                    </button>
                    <button type="button" class="btn btn-primary" id="startScanBtn">
                        <i class="fas fa-play me-1"></i>Iniciar Scanner
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="useIsbnBtn" style="display: none;">
                    <i class="fas fa-check me-1"></i>Usar este ISBN
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- QuaggaJS para scanner de código de barras -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>
// Variáveis globais para o scanner
let scannerActive = false;
let detectedISBN = '';

// Preview em tempo real
document.addEventListener('DOMContentLoaded', function() {
    const fields = {
        'titulo': 'preview-title',
        'autor': 'preview-author',
        'categoria': 'preview-category',
        'ano': 'preview-year',
        'paginas': 'preview-pages',
        'idioma': 'preview-language'
    };

    Object.keys(fields).forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const preview = document.getElementById(fields[fieldId]);

        field.addEventListener('input', function() {
            let value = this.value || (fieldId === 'titulo' ? 'Título do Livro' : 
                                      fieldId === 'autor' ? 'Autor' : 
                                      fieldId === 'categoria' ? 'Categoria' : '-');
            
            if (fieldId === 'ano') {
                value = value ? `Ano: ${value}` : 'Ano: -';
            } else if (fieldId === 'paginas') {
                value = value ? `Páginas: ${value}` : 'Páginas: -';
            } else if (fieldId === 'idioma') {
                value = `Idioma: ${value}`;
            }
            
            preview.textContent = value;
        });
    });

    // Validação do ISBN (opcional)
    document.getElementById('isbn').addEventListener('input', function() {
        validateISBN(this.value);
    });

    // Event listeners para o scanner
    initBarcodeScanner();
});

// Validação do ISBN
function validateISBN(isbn) {
    const isbnField = document.getElementById('isbn');
    const statusDiv = document.getElementById('isbn-status');
    const cleanISBN = isbn.replace(/[^0-9X-]/g, '');
    
    statusDiv.innerHTML = '';
    isbnField.classList.remove('is-valid', 'is-invalid', 'is-warning');
    
    if (cleanISBN.length === 0) {
        return;
    } else if (cleanISBN.length === 10 || cleanISBN.length === 13) {
        isbnField.classList.add('is-valid');
        statusDiv.innerHTML = '<small class="text-success"><i class="fas fa-check me-1"></i>ISBN válido</small>';
        
        // Buscar informações do livro
        if (cleanISBN.length === 13 || cleanISBN.length === 10) {
            searchBookByISBN(cleanISBN);
        }
    } else {
        isbnField.classList.add('is-warning');
        statusDiv.innerHTML = '<small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>ISBN deve ter 10 ou 13 dígitos</small>';
    }
}

// Buscar informações do livro por ISBN (Google Books API)
async function searchBookByISBN(isbn) {
    const statusDiv = document.getElementById('isbn-status');
    
    try {
        statusDiv.innerHTML = '<small class="text-info"><i class="fas fa-search me-1"></i>Buscando informações na Google Books API...</small>';
        
        // Tentar diferentes formatos de busca para melhor precisão
        const searchQueries = [
            `isbn:${isbn}`,
            `isbn13:${isbn}`,
            `isbn10:${isbn}`
        ];
        
        let bookFound = null;
        
        for (const query of searchQueries) {
            const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=1`);
            const data = await response.json();
            
            if (data.totalItems > 0) {
                bookFound = data.items[0].volumeInfo;
                break;
            }
        }
        
        if (bookFound) {
            await fillBookInfo(bookFound, isbn);
            statusDiv.innerHTML = '<small class="text-success"><i class="fas fa-magic me-1"></i>Informações preenchidas automaticamente da Google Books!</small>';
        } else {
            // Tentar busca alternativa por título se ISBN não retornar resultados
            statusDiv.innerHTML = '<small class="text-warning"><i class="fas fa-search me-1"></i>ISBN não encontrado na Google Books. Preencha manualmente.</small>';
        }
    } catch (error) {
        console.error('Erro ao buscar informações do livro:', error);
        statusDiv.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Erro ao conectar com a Google Books API</small>';
    }
}

// Preencher informações do livro automaticamente
async function fillBookInfo(book, isbn) {
    console.log('Dados recebidos da Google Books:', book);
    
    // 1. TÍTULO
    if (book.title) {
        const title = cleanText(book.title);
        document.getElementById('titulo').value = title;
        document.getElementById('preview-title').textContent = title;
    }
    
    // 2. AUTOR(ES)
    if (book.authors && book.authors.length > 0) {
        const authors = book.authors.map(author => cleanText(author)).join(', ');
        document.getElementById('autor').value = authors;
        document.getElementById('preview-author').textContent = authors;
    }
    
    // 3. ANO DE PUBLICAÇÃO
    if (book.publishedDate) {
        const year = book.publishedDate.split('-')[0];
        if (year && year.length === 4 && !isNaN(year)) {
            document.getElementById('ano').value = year;
            document.getElementById('preview-year').textContent = `Ano: ${year}`;
        }
    }
    
    // 4. EDITORA
    if (book.publisher) {
        const publisher = cleanText(book.publisher);
        document.getElementById('editora').value = publisher;
    }
    
    // 5. NÚMERO DE PÁGINAS
    if (book.pageCount && book.pageCount > 0) {
        document.getElementById('paginas').value = book.pageCount;
        document.getElementById('preview-pages').textContent = `Páginas: ${book.pageCount}`;
    }
    
    // 6. DESCRIÇÃO
    if (book.description) {
        let description = cleanText(book.description);
        // Remover tags HTML se existirem
        description = description.replace(/<[^>]*>/g, '');
        // Limitar a 1000 caracteres para descrição
        if (description.length > 1000) {
            description = description.substring(0, 997) + '...';
        }
        document.getElementById('descricao').value = description;
    }
    
    // 7. IDIOMA (mapeamento aprimorado)
    if (book.language) {
        const languageMap = {
            'pt': 'Português', 'pt-BR': 'Português', 'pt-PT': 'Português',
            'en': 'Inglês', 'en-US': 'Inglês', 'en-GB': 'Inglês',
            'es': 'Espanhol', 'es-ES': 'Espanhol', 'es-MX': 'Espanhol',
            'fr': 'Francês', 'fr-FR': 'Francês',
            'de': 'Alemão', 'de-DE': 'Alemão',
            'it': 'Italiano', 'it-IT': 'Italiano',
            'ja': 'Japonês', 'ko': 'Coreano', 'zh': 'Chinês',
            'ru': 'Russo', 'ar': 'Árabe', 'hi': 'Hindi'
        };
        
        const language = languageMap[book.language] || 'Outro';
        document.getElementById('idioma').value = language;
        document.getElementById('preview-language').textContent = `Idioma: ${language}`;
    }
    
    // 8. CATEGORIA (mapeamento muito mais abrangente)
    if (book.categories && book.categories.length > 0) {
        const category = book.categories[0].toLowerCase();
        const categorySelect = document.getElementById('categoria');
        
        // Mapeamento mais inteligente de categorias
        const categoryMap = {
            // Ficção e variações
            'fiction': 'Ficção',
            'literary fiction': 'Literatura Clássica',
            'contemporary fiction': 'Ficção',
            'historical fiction': 'Ficção',
            
            // Ficção Científica e Fantasia
            'science fiction': 'Ficção Científica',
            'fantasy': 'Ficção Científica',
            'dystopian': 'Ficção Científica',
            'speculative fiction': 'Ficção Científica',
            
            // História
            'history': 'História',
            'historical': 'História',
            'biography': 'Biografia',
            'autobiography': 'Biografia',
            
            // Filosofia e Ciências Sociais
            'philosophy': 'Filosofia',
            'psychology': 'Psicologia',
            'sociology': 'Psicologia',
            'political science': 'Ciência',
            
            // Literatura
            'literature': 'Literatura Clássica',
            'classic': 'Literatura Clássica',
            'poetry': 'Literatura Clássica',
            'drama': 'Literatura Clássica',
            
            // Infantil e Juvenil
            'juvenile fiction': 'Infantil',
            'juvenile': 'Infantil',
            'children': 'Infantil',
            'young adult': 'Infantil',
            
            // Romance
            'romance': 'Romance',
            'love story': 'Romance',
            
            // Ciência e Tecnologia
            'science': 'Ciência',
            'technology': 'Tecnologia',
            'mathematics': 'Matemática',
            'computer science': 'Tecnologia',
            'computers': 'Tecnologia',
            'programming': 'Tecnologia',
            'engineering': 'Tecnologia',
            
            // Arte e Cultura
            'art': 'Arte',
            'music': 'Arte',
            'photography': 'Arte',
            'design': 'Arte',
            
            // Medicina e Saúde
            'medical': 'Medicina e Saúde',
            'medicine': 'Medicina e Saúde',
            'health': 'Medicina e Saúde',
            'anatomy': 'Medicina e Saúde',
            'nursing': 'Medicina e Saúde',
            
            // Direito
            'law': 'Direito',
            'legal': 'Direito',
            'constitutional': 'Direito',
            'jurisprudence': 'Direito',
            
            // Economia e Negócios
            'economics': 'Economia',
            'business': 'Economia',
            'finance': 'Economia',
            'management': 'Economia',
            'marketing': 'Economia',
            'accounting': 'Economia',
            
            // Educação
            'education': 'Educação',
            'teaching': 'Educação',
            'pedagogy': 'Educação',
            'learning': 'Educação',
            
            // Geografia
            'geography': 'Geografia',
            'travel': 'Geografia',
            'maps': 'Geografia',
            'atlas': 'Geografia',
            
            // Línguas
            'language': 'Línguas',
            'linguistics': 'Línguas',
            'dictionary': 'Línguas',
            'grammar': 'Línguas',
            'foreign language': 'Línguas',
            
            // Religião
            'religion': 'Religião',
            'theology': 'Religião',
            'spirituality': 'Religião',
            'bible': 'Religião',
            'islam': 'Religião',
            'christianity': 'Religião',
            
            // Autoajuda
            'self-help': 'Autoajuda',
            'self help': 'Autoajuda',
            'personal development': 'Autoajuda',
            'motivation': 'Autoajuda',
            'success': 'Autoajuda',
            
            // Culinária
            'cooking': 'Culinária',
            'cookbooks': 'Culinária',
            'recipes': 'Culinária',
            'food': 'Culinária',
            'baking': 'Culinária',
            
            // Desporto
            'sports': 'Desporto',
            'fitness': 'Desporto',
            'exercise': 'Desporto',
            'athletics': 'Desporto',
            'games': 'Desporto'
        };
        
        let mappedCategory = 'Ficção'; // Padrão
        
        // Tentar encontrar correspondência
        for (const [key, value] of Object.entries(categoryMap)) {
            if (category.includes(key)) {
                mappedCategory = value;
                break;
            }
        }
        
        categorySelect.value = mappedCategory;
        document.getElementById('preview-category').textContent = mappedCategory;
    }
    
    // 9. CAPA DO LIVRO (nova funcionalidade)
    if (book.imageLinks) {
        let imageUrl = null;
        
        // Tentar obter a melhor qualidade disponível
        if (book.imageLinks.extraLarge) {
            imageUrl = book.imageLinks.extraLarge;
        } else if (book.imageLinks.large) {
            imageUrl = book.imageLinks.large;
        } else if (book.imageLinks.medium) {
            imageUrl = book.imageLinks.medium;
        } else if (book.imageLinks.thumbnail) {
            imageUrl = book.imageLinks.thumbnail;
        }
        
        if (imageUrl) {
            // Melhorar qualidade da imagem se possível
            imageUrl = imageUrl.replace('&edge=curl', '').replace('zoom=1', 'zoom=2');
            
            // Atualizar preview da capa
            const previewCover = document.getElementById('preview-cover');
            previewCover.src = imageUrl;
                         previewCover.onerror = function() {
                 // Se falhar ao carregar, usar placeholder SVG
                 this.src = 'data:image/svg+xml;base64,' + btoa(`
                     <svg width="120" height="180" xmlns="http://www.w3.org/2000/svg">
                         <rect width="120" height="180" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>
                         <text x="60" y="90" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#6c757d">Sem Capa</text>
                         <text x="60" y="110" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#adb5bd">Disponível</text>
                     </svg>
                 `);
             };
            
            console.log('Capa do livro carregada:', imageUrl);
        }
    }
    
    // 10. STATUS PADRÃO
    document.getElementById('status').value = 'disponivel';
    
    // 11. FEEDBACK VISUAL
    showSuccessMessage('Informações preenchidas automaticamente!');
}

// Função auxiliar para limpar texto
function cleanText(text) {
    if (!text) return '';
    return text.trim()
        .replace(/\s+/g, ' ')  // Múltiplos espaços para um só
        .replace(/[\r\n]+/g, ' ');  // Quebras de linha para espaço
}

// Função para mostrar mensagens de sucesso
function showSuccessMessage(message) {
    // Criar um toast ou notificação visual
    const toastHtml = `
        <div class="toast position-fixed top-0 end-0 m-3" style="z-index: 9999;" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Sucesso</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    const toast = new bootstrap.Toast(document.body.lastElementChild);
    toast.show();
    
    // Remover o elemento após 5 segundos
    setTimeout(() => {
        const toastElement = document.body.lastElementChild;
        if (toastElement && toastElement.classList.contains('toast')) {
            toastElement.remove();
        }
    }, 5000);
}

// Inicializar scanner de código de barras
function initBarcodeScanner() {
    const scanBtn = document.getElementById('scanBarcodeBtn');
    const startScanBtn = document.getElementById('startScanBtn');
    const stopScanBtn = document.getElementById('stopScanBtn');
    const useIsbnBtn = document.getElementById('useIsbnBtn');
    const modal = new bootstrap.Modal(document.getElementById('barcodeModal'));

    // Abrir modal do scanner
    scanBtn.addEventListener('click', function() {
        modal.show();
    });

    // Iniciar scanner
    startScanBtn.addEventListener('click', function() {
        startBarcodeScanner();
    });

    // Parar scanner
    stopScanBtn.addEventListener('click', function() {
        stopBarcodeScanner();
    });

    // Usar ISBN detectado
    useIsbnBtn.addEventListener('click', function() {
        document.getElementById('isbn').value = detectedISBN;
        validateISBN(detectedISBN);
        modal.hide();
        stopBarcodeScanner();
    });

    // Limpar scanner ao fechar modal
    document.getElementById('barcodeModal').addEventListener('hidden.bs.modal', function() {
        stopBarcodeScanner();
    });
}

// Iniciar scanner de código de barras
function startBarcodeScanner() {
    const loadingDiv = document.getElementById('camera-loading');
    const errorDiv = document.getElementById('camera-error');
    const startBtn = document.getElementById('startScanBtn');
    const stopBtn = document.getElementById('stopScanBtn');
    
    loadingDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    startBtn.style.display = 'none';

    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: {
                width: 640,
                height: 480,
                facingMode: "environment" // usar câmera traseira se disponível
            }
        },
        locator: {
            patchSize: "medium",
            halfSample: true
        },
        numOfWorkers: 2,
        decoder: {
            readers: [
                "ean_reader",
                "ean_8_reader",
                "ean_13_reader",
                "code_128_reader",
                "code_39_reader"
            ]
        },
        locate: true
    }, function(err) {
        loadingDiv.style.display = 'none';
        
        if (err) {
            console.error('Erro ao inicializar scanner:', err);
            errorDiv.style.display = 'block';
            document.getElementById('error-message').textContent = 'Erro ao aceder à câmera. Verifique as permissões.';
            startBtn.style.display = 'inline-block';
            return;
        }
        
        console.log("Scanner iniciado com sucesso");
        Quagga.start();
        scannerActive = true;
        stopBtn.style.display = 'inline-block';
    });

    // Evento quando código é detectado
    Quagga.onDetected(function(data) {
        const code = data.codeResult.code;
        console.log("Código detectado:", code);
        
        // Verificar se é um ISBN válido (10 ou 13 dígitos)
        if (isValidISBN(code)) {
            detectedISBN = code;
            document.getElementById('detected-isbn').textContent = code;
            document.getElementById('scan-result').style.display = 'block';
            document.getElementById('useIsbnBtn').style.display = 'inline-block';
            
            // Buscar informações do livro
            document.getElementById('book-info-loading').style.display = 'block';
            searchBookInfoForModal(code);
            
            // Parar scanner após detecção
            stopBarcodeScanner();
        }
    });
}

// Parar scanner
function stopBarcodeScanner() {
    if (scannerActive) {
        Quagga.stop();
        scannerActive = false;
    }
    
    document.getElementById('startScanBtn').style.display = 'inline-block';
    document.getElementById('stopScanBtn').style.display = 'none';
    document.getElementById('camera-loading').style.display = 'none';
}

// Validar se é um ISBN
function isValidISBN(code) {
    const cleanCode = code.replace(/[^0-9X]/g, '');
    return cleanCode.length === 10 || cleanCode.length === 13;
}

// Buscar informações do livro para o modal (versão melhorada)
async function searchBookInfoForModal(isbn) {
    const loadingDiv = document.getElementById('book-info-loading');
    const infoDiv = document.getElementById('book-info');
    
    try {
        // Usar a mesma lógica de busca melhorada
        const searchQueries = [
            `isbn:${isbn}`,
            `isbn13:${isbn}`,
            `isbn10:${isbn}`
        ];
        
        let bookFound = null;
        
        for (const query of searchQueries) {
            const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=1`);
            const data = await response.json();
            
            if (data.totalItems > 0) {
                bookFound = data.items[0].volumeInfo;
                break;
            }
        }
        
        loadingDiv.style.display = 'none';
        
        if (bookFound) {
            const book = bookFound;
            
                         // Obter a melhor qualidade de imagem  
             let imageUrl = 'data:image/svg+xml;base64,' + btoa(`
                 <svg width="120" height="180" xmlns="http://www.w3.org/2000/svg">
                     <rect width="120" height="180" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>
                     <text x="60" y="90" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#6c757d">Sem Capa</text>
                     <text x="60" y="110" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#adb5bd">Disponível</text>
                 </svg>
             `);
            if (book.imageLinks) {
                if (book.imageLinks.large) {
                    imageUrl = book.imageLinks.large;
                } else if (book.imageLinks.medium) {
                    imageUrl = book.imageLinks.medium;
                } else if (book.imageLinks.thumbnail) {
                    imageUrl = book.imageLinks.thumbnail;
                }
                // Melhorar qualidade
                imageUrl = imageUrl.replace('&edge=curl', '').replace('zoom=1', 'zoom=2');
            }
            
            // Mapear categoria
            let category = 'Ficção';
            if (book.categories && book.categories.length > 0) {
                const cat = book.categories[0].toLowerCase();
                
                // Mapeamento mais abrangente para as novas categorias
                if (cat.includes('fiction')) category = 'Ficção';
                else if (cat.includes('science fiction')) category = 'Ficção Científica';
                else if (cat.includes('technology') || cat.includes('computer')) category = 'Tecnologia';
                else if (cat.includes('mathematics') || cat.includes('math')) category = 'Matemática';
                else if (cat.includes('science')) category = 'Ciência';
                else if (cat.includes('medical') || cat.includes('medicine') || cat.includes('health')) category = 'Medicina e Saúde';
                else if (cat.includes('law') || cat.includes('legal')) category = 'Direito';
                else if (cat.includes('economics') || cat.includes('business') || cat.includes('finance')) category = 'Economia';
                else if (cat.includes('psychology')) category = 'Psicologia';
                else if (cat.includes('education') || cat.includes('teaching')) category = 'Educação';
                else if (cat.includes('geography') || cat.includes('travel')) category = 'Geografia';
                else if (cat.includes('language') || cat.includes('dictionary')) category = 'Línguas';
                else if (cat.includes('religion') || cat.includes('theology')) category = 'Religião';
                else if (cat.includes('self-help') || cat.includes('self help') || cat.includes('motivation')) category = 'Autoajuda';
                else if (cat.includes('cooking') || cat.includes('recipes') || cat.includes('food')) category = 'Culinária';
                else if (cat.includes('sports') || cat.includes('fitness') || cat.includes('exercise')) category = 'Desporto';
                else if (cat.includes('history')) category = 'História';
                else if (cat.includes('biography')) category = 'Biografia';
                else if (cat.includes('juvenile') || cat.includes('children')) category = 'Infantil';
                else if (cat.includes('romance')) category = 'Romance';
                else if (cat.includes('philosophy')) category = 'Filosofia';
                else if (cat.includes('art') || cat.includes('music') || cat.includes('photography')) category = 'Arte';
            }
            
            // Mapear idioma
            let language = 'Português';
            if (book.language) {
                const languageMap = {
                    'pt': 'Português', 'pt-BR': 'Português',
                    'en': 'Inglês', 'en-US': 'Inglês',
                    'es': 'Espanhol', 'fr': 'Francês',
                    'de': 'Alemão', 'it': 'Italiano'
                };
                language = languageMap[book.language] || 'Outro';
            }
            
            infoDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-7">
                        <h6 class="text-primary">${cleanText(book.title) || 'Título não disponível'}</h6>
                        <div class="book-details">
                            <p class="mb-1">
                                <i class="fas fa-user text-muted me-1"></i>
                                <strong>Autor:</strong> ${book.authors ? book.authors.map(a => cleanText(a)).join(', ') : 'Não disponível'}
                            </p>
                            <p class="mb-1">
                                <i class="fas fa-building text-muted me-1"></i>
                                <strong>Editora:</strong> ${cleanText(book.publisher) || 'Não disponível'}
                            </p>
                            <p class="mb-1">
                                <i class="fas fa-calendar text-muted me-1"></i>
                                <strong>Ano:</strong> ${book.publishedDate ? book.publishedDate.split('-')[0] : 'Não disponível'}
                            </p>
                            <p class="mb-1">
                                <i class="fas fa-file-alt text-muted me-1"></i>
                                <strong>Páginas:</strong> ${book.pageCount || 'Não disponível'}
                            </p>
                            <p class="mb-1">
                                <i class="fas fa-tags text-muted me-1"></i>
                                <strong>Categoria:</strong> <span class="badge bg-primary">${category}</span>
                            </p>
                            <p class="mb-0">
                                <i class="fas fa-language text-muted me-1"></i>
                                <strong>Idioma:</strong> ${language}
                            </p>
                        </div>
                        ${book.description ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Descrição:</strong> ${cleanText(book.description).substring(0, 150)}${book.description.length > 150 ? '...' : ''}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                    <div class="col-md-5 text-center">
                        <img src="${imageUrl}" class="img-fluid rounded shadow-sm" alt="Capa do livro" 
                             style="max-height: 200px; object-fit: cover;"
                              onerror="this.src='data:image/svg+xml;base64,' + btoa(\`<svg width='120' height='180' xmlns='http://www.w3.org/2000/svg'><rect width='120' height='180' fill='#f8f9fa' stroke='#dee2e6' stroke-width='2'/><text x='60' y='90' font-family='Arial, sans-serif' font-size='12' text-anchor='middle' fill='#6c757d'>Sem Capa</text></svg>\`);">
                        <div class="mt-2">
                            <small class="text-success">
                                <i class="fas fa-check-circle me-1"></i>
                                Dados da Google Books
                            </small>
                        </div>
                    </div>
                </div>
            `;
            infoDiv.style.display = 'block';
        } else {
            infoDiv.innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">Nenhuma informação encontrada na Google Books para este ISBN.</p>
                    <small class="text-muted">Você pode preencher as informações manualmente após usar o ISBN.</small>
                </div>
            `;
            infoDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Erro ao buscar informações:', error);
        loadingDiv.style.display = 'none';
        infoDiv.innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                <p class="text-warning mb-0">Erro ao conectar com a Google Books API.</p>
                <small class="text-muted">Verifique sua conexão com a internet.</small>
            </div>
        `;
        infoDiv.style.display = 'block';
    }
}

// Preview da imagem
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-cover').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Validação do formulário
document.querySelector('form').addEventListener('submit', function(e) {
    const titulo = document.getElementById('titulo').value.trim();
    const autor = document.getElementById('autor').value.trim();
    const categoria = document.getElementById('categoria').value;

    if (!titulo || !autor || !categoria) {
        e.preventDefault();
        alert('Por favor, preencha todos os campos obrigatórios (Título, Autor, Categoria).');
        return false;
    }
});
</script>
{% endblock %}

